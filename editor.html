<!DOCTYPE html>
<html lang="fi">
<head>
<meta charset="UTF-8">
<title>T√§htikirja ‚Äì Editor</title>
<style>
  body {
    margin: 0;
    font-family: system-ui, sans-serif;
    display: grid;
    grid-template-columns: 260px 1fr 280px;
    height: 100vh;
  }
  #chapters {
    border-right: 1px solid #ccc;
    overflow-y: auto;
    padding: 12px;
  }
  #editor {
    padding: 12px;
    display: flex;
    flex-direction: column;
  }
  #md {
    flex: 1;
    width: 100%;
    margin-bottom: 10px;
  }
  #preview {
    flex: 1;
    background: #fafafa;
    padding: 12px;
    border: 1px solid #ddd;
    overflow-y: auto;
  }
  #meta {
    border-left: 1px solid #ccc;
    padding: 12px;
    overflow-y: auto;
  }
  button { padding: 6px 12px; margin-top: 8px; }
  .chapter-item {
    padding: 8px;
    border-bottom: 1px solid #eee;
    cursor: pointer;
  }
  .chapter-item:hover {
    background: #f0f0f0;
  }
  .active { background: #e8e8ff !important; }
</style>
</head>
<body>

<!-- VASEN: CHAPTER LIST -->
<div id="chapters">
  <h3>Luvut</h3>
  <div id="chapterList"></div>
  <button onclick="newChapter()">+ Lis√§√§ uusi luku</button>
</div>

<!-- KESKI: EDITORI -->
<div id="editor">
  <textarea id="md" placeholder="Kirjoita Markdownia..."></textarea>
  <div id="preview"></div>
</div>

<!-- OIKEA: META -->
<div id="meta">
  <h3>Metadata</h3>
  <label>ID</label><br>
  <input id="meta_id" style="width:100%"><br><br>
  <label>Otsikko</label><br>
  <input id="meta_title" style="width:100%"><br><br>
  <label>Tiivistelm√§</label><br>
  <textarea id="meta_summary" style="width:100%" rows="4"></textarea>
  
  <button onclick="saveChapter()">üíæ Tallenna</button>
</div>

<script>
// --------------------------------------
// 1) Asetukset
// --------------------------------------
const GH_USER  = "YOUR_USERNAME";
const GH_REPO  = "YOUR_REPO";
const FILEPATH = "chapters.json";

// Token tallennetaan localStorageen
let TOKEN = localStorage.getItem("gh_token") || null;
if (!TOKEN) {
  TOKEN = prompt("Anna GitHub token:");
  localStorage.setItem("gh_token", TOKEN);
}

// --------------------------------------
// 2) Data load
// --------------------------------------
let chapters = [];
let selected = null;

async function loadChapters() {
  const res = await fetch(`https://raw.githubusercontent.com/${GH_USER}/${GH_REPO}/main/${FILEPATH}`);
  chapters = await res.json();
  renderChapterList();
}

function renderChapterList() {
  const list = document.getElementById("chapterList");
  list.innerHTML = "";

  chapters.forEach((ch, idx) => {
    const div = document.createElement("div");
    div.className = "chapter-item" + (selected === idx ? " active" : "");
    div.textContent = `${ch.id} ‚Äì ${ch.title}`;
    div.onclick = () => selectChapter(idx);
    list.appendChild(div);
  });
}

function selectChapter(i) {
  selected = i;
  const ch = chapters[i];
  document.getElementById("meta_id").value = ch.id;
  document.getElementById("meta_title").value = ch.title;
  document.getElementById("meta_summary").value = ch.summary || "";
  document.getElementById("md").value = ch.body_md;
  renderPreview();
  renderChapterList();
}

// --------------------------------------
// 3) Markdown preview
// --------------------------------------
function renderPreview() {
  const md = document.getElementById("md").value;
  const html = md.replace(/\n/g, "<br>")
                 .replace(/\*\*(.+?)\*\*/g,"<strong>$1</strong>");
  document.getElementById("preview").innerHTML = html;
}
document.getElementById("md").addEventListener("input", renderPreview);

// --------------------------------------
// 4) Lis√§√§ uusi luku
// --------------------------------------
function newChapter() {
  const id = String(chapters.length + 1).padStart(3,"0");
  chapters.push({
    id,
    title: "Uusi luku",
    summary: "",
    body_md: ""
  });
  selectChapter(chapters.length-1);
  renderChapterList();
}

// --------------------------------------
// 5) Tallenna GitHubiin
// --------------------------------------
async function saveChapter() {
  if (selected == null) return;
  chapters[selected] = {
    id: document.getElementById("meta_id").value,
    title: document.getElementById("meta_title").value,
    summary: document.getElementById("meta_summary").value,
    body_md: document.getElementById("md").value
  };

  // 1. Nouda SHA (tarvitaan GitHub API:lle)
  const metaRes = await fetch(
    `https://api.github.com/repos/${GH_USER}/${GH_REPO}/contents/${FILEPATH}`,
    { headers: { Authorization: `Bearer ${TOKEN}` }}
  );
  const meta = await metaRes.json();

  // 2. L√§het√§ uusi sis√§lt√∂ base64:na
  const updated = btoa(unescape(encodeURIComponent(JSON.stringify(chapters, null, 2))));

  await fetch(
    `https://api.github.com/repos/${GH_USER}/${GH_REPO}/contents/${FILEPATH}`,
    {
      method: "PUT",
      headers: {
        Authorization: `Bearer ${TOKEN}`,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        message: "Update chapter",
        content: updated,
        sha: meta.sha
      })
    }
  );

  alert("Tallennettu!");
}

loadChapters();
</script>
</body>
</html>
