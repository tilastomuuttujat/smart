<!DOCTYPE html>
<html lang="fi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>T√§htikirja ‚Äì lukutila</title>
  <style>
    :root{
      --bg: #f4efe5;
      --paper: #f8f3ea;
      --ink: #2d2822;
      --mut: #8d8477;
      --accent: #c59a6c;
      --accent-soft: rgba(197,154,108,0.15);
    }
    *{ box-sizing:border-box; }

    html,body{
      margin:0;
      padding:0;
      height:100%;
      background: radial-gradient(circle at 50% 0%, #f6f1e7 0%, #f0e7dd 50%, #e7ddd2 100%);
      color:var(--ink);
      font:15px/1.6 system-ui,-apple-system,BlinkMacSystemFont,"SF Pro Text","Segoe UI",sans-serif;
      -webkit-font-smoothing: antialiased;
      overflow:hidden;
    }

    body{
      display:flex;
      align-items:stretch;
      justify-content:center;
    }

    #app{
      flex:1;
      display:flex;
      justify-content:center;
      align-items:stretch;
      padding:10px 8px 16px;
    }

    /* Ei korttia ‚Äì teksti lep√§√§ suoraan taustan p√§√§ll√§ */
    #readerShell{
      position:relative;
      width:100%;
      max-width:780px;
      height:100%;
      border-radius:0;
      background:transparent;
      box-shadow:none;
      padding:16px 16px 16px;
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }

    #scrollContainer{
      position:relative;
      width:100%;
      height:100%;
      overflow-y:auto;
      overflow-x:hidden;
      -webkit-overflow-scrolling:touch;
      scrollbar-width:thin;
      scrollbar-color:rgba(0,0,0,0.15) transparent;
    }
    #scrollContainer::-webkit-scrollbar{
      width:6px;
    }
    #scrollContainer::-webkit-scrollbar-thumb{
      background:rgba(0,0,0,0.18);
      border-radius:999px;
    }

    #chapterContainer{
      max-width:640px;
      margin:0 auto;
      padding-bottom:24px;
    }

    .chapter-title{
      font-size:22px;
      font-weight:600;
      letter-spacing:0.03em;
      margin:0 0 10px;
    }
    .chapter-meta{
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:0.18em;
      color:var(--mut);
      margin-bottom:18px;
    }

    .chapter-body{
      font-size:15px;
    }
    .chapter-body h2{
      font-size:18px;
      margin:22px 0 8px;
      font-weight:600;
      letter-spacing:0.02em;
    }
    .chapter-body p{
      margin:0 0 10px;
    }
    .chapter-body strong{
      font-weight:600;
    }
    .chapter-body mark{
      background:#fff59d;
      color:inherit;
      padding:0 1px;
      border-radius:3px;
    }

    /* Koko n√§yt√∂n 2D/3D-tausta */
    #mi-section{
      position:fixed;
      inset:0;
      width:100vw;
      height:100vh;
      padding:0;
      margin:0;
      box-sizing:border-box;
      display:none;       /* n√§kyy vain karttatilassa */
      z-index:60;
      pointer-events:auto;
    }

    #mi-inner{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      display:flex;
      flex-direction:column;
    }

    #mi-stage{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      border-radius:0;
      background:transparent;
      box-shadow:none;
      overflow:hidden;
      touch-action:none;  /* kaksi sormea: pan/zoom */
    }

    /* 2D- ja 3D-n√§kym√§t t√§ytt√§v√§t koko mi-stage alueen */
    .mi-view{
      position:absolute;
      inset:0;
    }

    /* Statuspilleri */
    #footerStatus{
      position:fixed;
      left:50%;
      bottom:10px;
      transform:translateX(-50%);
      min-width:140px;
      max-width:70vw;
      text-align:center;
      font-size:11px;
      color:rgba(0,0,0,0.45);
      padding:4px 10px;
      border-radius:999px;
      background:rgba(255,255,255,0.9);
      box-shadow:0 6px 20px rgba(0,0,0,0.12);
      pointer-events:none;
      opacity:0;
      transition:opacity 0.25s ease;
      z-index:90;
    }
    #footerStatus.visible{
      opacity:1;
    }

    /* Kontekstivalikko (voi olla taustalla) */
    #contextMenu{
      position:fixed;
      min-width:170px;
      background:rgba(248,242,233,0.98);
      border-radius:14px;
      box-shadow:
        0 18px 40px rgba(0,0,0,0.28),
        0 0 0 1px rgba(255,255,255,0.8);
      padding:6px 6px;
      font-size:13px;
      z-index:80;
      display:none;
    }
    #contextMenu button{
      width:100%;
      border:none;
      background:transparent;
      padding:6px 9px;
      text-align:left;
      border-radius:10px;
      font-size:13px;
      color:var(--ink);
      display:flex;
      align-items:center;
      gap:6px;
      cursor:pointer;
    }
    #contextMenu button span.icon{
      font-size:15px;
      opacity:0.9;
    }
    #contextMenu button:hover{
      background:rgba(0,0,0,0.04);
    }

    #longpressDot{
      position:fixed;
      width:18px;
      height:18px;
      border-radius:999px;
      background:rgba(0,0,0,0.08);
      border:1px solid rgba(0,0,0,0.25);
      transform:translate(-50%,-50%);
      pointer-events:none;
      opacity:0;
      transition:opacity 0.12s ease;
      z-index:79;
    }
    #longpressDot.visible{
      opacity:1;
    }

    /* Hakemisto + tekstipaneeli oikealla kartan p√§√§ll√§ */
    #tocOverlay{
      position:fixed;
      inset:0;
      background:transparent;
      display:none;
      justify-content:flex-end;
      align-items:stretch;
      z-index:75;
      pointer-events:none; /* vain paneeli vastaanottaa klikkaukset */
    }
    #tocPanel{
      width:min(380px, 45vw);
      height:100%;
      background:linear-gradient(
        180deg,
        rgba(252,246,238,0.98) 0%,
        rgba(249,241,230,0.96) 45%,
        rgba(244,236,225,0.96) 100%
      );
      border-radius:18px 0 0 18px;
      box-shadow:-18px 0 40px rgba(0,0,0,0.28);
      padding:10px 12px 10px;
      display:flex;
      flex-direction:column;
      gap:8px;
      border-left:1px solid rgba(255,255,255,0.7);
      pointer-events:auto;
    }

    #tocHeader{
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-size:13px;
      font-weight:600;
      color:var(--ink);
      gap:6px;
    }
    #tocHeader-left,
    #tocHeader-center,
    #tocHeader-right{
      display:flex;
      align-items:center;
      gap:6px;
    }

    /* Teksti-painike vasemmalla */
    #mi-btn-text{
      border:none;
      background:rgba(0,0,0,0.04);
      padding:4px 10px;
      border-radius:999px;
      font-size:11px;
      cursor:pointer;
    }
    #mi-btn-text:hover{
      background:rgba(0,0,0,0.08);
    }

    #tocCloseBtn{
      border:none;
      background:transparent;
      font-size:18px;
      cursor:pointer;
      padding:0 4px;
    }

    /* 2D/3D pilleri keskell√§ */
    .mi-pill{
      display:inline-flex;
      border-radius:999px;
      padding:2px;
      background:rgba(0,0,0,0.16);
    }
    .mi-pill button{
      border:none;
      background:transparent;
      padding:4px 10px;
      border-radius:999px;
      font-size:11px;
      cursor:pointer;
      color:rgba(255,255,255,0.8);
      min-width:38px;
    }
    .mi-pill button.mi-active{
      background:#fdf7ec;
      color:var(--ink);
      box-shadow:0 0 0 1px rgba(255,255,255,0.7);
    }

    /* Paneli-painike oikealla */
    #mi-btn-panel{
      padding:4px 10px;
      border-radius:999px;
      border:1px solid rgba(0,0,0,0.14);
      background:rgba(255,255,255,0.9);
      color:var(--ink);
      cursor:pointer;
      font-size:11px;
      display:inline-flex;
      align-items:center;
      gap:4px;
    }
    #mi-btn-panel:hover{
      background:#ffffff;
    }

    /* Sis√§lt√∂: yl√§osa hakemisto (1/3), alaosa tekstipaneeli (2/3) */
    #tocContent{
      flex:1;
      display:flex;
      flex-direction:column;
      gap:6px;
      min-height:0;
      margin-top:4px;
    }
    #tocListWrapper{
      flex:0.33;          /* ~1/3 korkeudesta */
      min-height:0;
      overflow:auto;
      font-size:13px;
    }
    #tocList{
      margin:0;
      padding:4px 0 4px;
      list-style:none;
    }
    #tocList li{
      padding:4px 6px;
      border-radius:10px;
      cursor:pointer;
      display:flex;
      flex-direction:column;
      gap:2px;
      margin-bottom:2px;
    }
    #tocList li:hover{
      background:rgba(0,0,0,0.04);
    }
    /* TOC: aktiivinen luku */
    #tocList li.toc-current{
      background:rgba(0,0,0,0.06);
      box-shadow:0 0 0 1px rgba(0,0,0,0.06);
    }
    #tocList li.toc-current .toc-title{
      font-weight:600;
    }
    .toc-title{
      font-weight:500;
    }
    .toc-meta{
      font-size:10px;
      color:var(--mut);
      text-transform:uppercase;
      letter-spacing:0.14em;
    }

    #tocTextPreview{
      flex:0.67;          /* ~2/3 korkeudesta */
      min-height:0;
      overflow:auto;
      padding:6px 2px 6px;
      border-radius:0;
      background:transparent;   /* sama tausta kuin takana */
      font-size:13px;
      box-shadow:none;
    }

    .mini-chapter-block{
      background:transparent;
      border-radius:0;
      box-shadow:none;
      margin:0 0 12px;
      padding:0 4px 8px;
      border-bottom:1px solid rgba(0,0,0,0.06);
    }

    .toc-preview-meta{
      font-size:10px;
      text-transform:uppercase;
      letter-spacing:0.16em;
      color:var(--mut);
      margin-bottom:4px;
    }
    .toc-preview-title{
      font-weight:600;
      margin-bottom:6px;
    }
    .toc-preview-body{
      font-size:13px;
      line-height:1.55;
    }
    .toc-preview-body p{
      margin:0 0 6px;
    }

    /* Infografiikka */
    #figureOverlay{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.2);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:72;
    }
    #figureFrame{
      position:relative;
      max-width:90vw;
      max-height:80vh;
      border-radius:18px;
      overflow:hidden;
      background:rgba(10,8,6,0.5);
      backdrop-filter:blur(10px);
      box-shadow:0 22px 70px rgba(0,0,0,0.6);
    }
    #figureImg{
      display:block;
      max-width:100%;
      max-height:100%;
    }

    /* Luvun sis√§inen hakupalkki */
    #searchBar{
      position:fixed;
      top:12px;
      left:50%;
      transform:translateX(-50%);
      display:none;
      align-items:center;
      gap:6px;
      padding:4px 10px;
      border-radius:999px;
      background:rgba(255,255,255,0.96);
      box-shadow:0 10px 30px rgba(0,0,0,0.18);
      font-size:13px;
      z-index:85;
    }
    #searchInput{
      border:none;
      outline:none;
      min-width:160px;
      max-width:40vw;
      font:inherit;
      background:transparent;
      color:var(--ink);
    }
    #searchCount{
      min-width:40px;
      text-align:center;
      font-size:11px;
      color:var(--mut);
    }
    #searchPrevBtn,
    #searchNextBtn,
    #searchCloseBtn{
      border:none;
      background:transparent;
      font-size:13px;
      cursor:pointer;
      padding:3px 6px;
      border-radius:999px;
    }
    #searchPrevBtn:hover,
    #searchNextBtn:hover{
      background:rgba(0,0,0,0.05);
    }
    #searchCloseBtn{
      font-size:16px;
      line-height:1;
      padding:2px 6px;
    }

    /* Koko kirjan hakutulokset */
    #bookSearchOverlay{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.12);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:86;
    }
    #bookSearchPanel{
      width:90vw;
      max-width:520px;
      max-height:70vh;
      padding:12px;
      background:rgba(255,255,255,0.96);
      border-radius:16px;
      box-shadow:0 20px 60px rgba(0,0,0,0.3);
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    #bookSearchHeader{
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-weight:600;
      font-size:14px;
    }
    #bookSearchCloseBtn{
      border:none;
      background:transparent;
      font-size:20px;
      cursor:pointer;
    }
    #bookSearchList{
      list-style:none;
      padding:0;
      margin:0;
      overflow:auto;
      flex:1;
      font-size:14px;
    }
    #bookSearchList li{
      padding:6px 4px;
      border-radius:8px;
      cursor:pointer;
    }
    #bookSearchList li:hover{
      background:rgba(0,0,0,0.05);
    }

    @media(max-width:768px){
      #readerShell{
        padding:10px;
      }
      #chapterContainer{
        max-width:100%;
      }
      .chapter-title{
        font-size:20px;
      }
    }
  </style>

  <script type="importmap">
  {
    "imports": {
      "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js"
    }
  }
  </script>

  <!-- Three.js 3D:lle -->
  <script src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>
  <!-- Sammalkartta 2D -->
  <script src="sammalkartta.js"></script>
  <!-- Taivaskartta 3D -->
  <script type="module" src="taivaskartta.js"></script>
</head>
<body>
<div id="app">
  <div id="readerShell">
    <!-- Tekstin√§ytt√∂ -->
    <div id="scrollContainer">
      <div id="chapterContainer"></div>
    </div>
  </div>
</div>

<!-- Koko n√§yt√∂n 2D/3D-tausta -->
<section id="mi-section">
  <div id="mi-inner">
    <div id="mi-stage">
      <div id="sammal2d-container" class="mi-view"></div>
      <div id="taivaskartta-section" class="mi-view"></div>
    </div>
  </div>
</section>

<div id="footerStatus"></div>

<div id="contextMenu">
  <button data-action="toc"><span class="icon">‚ò∞</span><span>Hakemisto</span></button>
  <button data-action="search"><span class="icon">üîç</span><span>Haku luvusta</span></button>
  <button data-action="figure"><span class="icon">üñºÔ∏è</span><span>Infografiikka</span></button>
  <button data-action="sammal2d"><span class="icon">üß¨</span><span>Sammalkartta 2D</span></button>
  <button data-action="sammal3d"><span class="icon">‚ú∂</span><span>Taivaskartta 3D</span></button>
  <button data-action="cancel"><span class="icon">‚úï</span><span>Peruuta</span></button>
</div>

<div id="longpressDot"></div>

<div id="tocOverlay">
  <div id="tocPanel">
    <div id="tocHeader">
      <div id="tocHeader-left">
        <button id="mi-btn-text">Teksti</button>
      </div>
      <div id="tocHeader-center">
        <div class="mi-pill">
          <button id="mi-btn-2d" class="mi-active">2D</button>
          <button id="mi-btn-3d">3D</button>
        </div>
      </div>
      <div id="tocHeader-right">
        <button id="mi-btn-panel">Paneli</button>
        <button id="tocCloseBtn" aria-label="Sulje">&times;</button>
      </div>
    </div>
    <div id="tocContent">
      <div id="tocListWrapper">
        <ul id="tocList"></ul>
      </div>
      <div id="tocTextPreview"></div>
    </div>
  </div>
</div>

<div id="figureOverlay">
  <div id="figureFrame">
    <img id="figureImg" alt="Infografiikka" />
  </div>
</div>

<div id="searchBar">
  <input id="searchInput" type="text" placeholder="Haku (Enter = koko kirja)" />
  <span id="searchCount">0/0</span>
  <button id="searchPrevBtn" title="Edellinen osuma">‚óÄ</button>
  <button id="searchNextBtn" title="Seuraava osuma">‚ñ∂</button>
  <button id="searchCloseBtn" aria-label="Sulje haku">√ó</button>
</div>

<div id="bookSearchOverlay">
  <div id="bookSearchPanel">
    <div id="bookSearchHeader">
      <span>Hakutulokset</span>
      <button id="bookSearchCloseBtn">√ó</button>
    </div>
    <ul id="bookSearchList"></ul>
  </div>
</div>

<script>
(function(){
  const chapterContainer   = document.getElementById("chapterContainer");
  const scrollContainer    = document.getElementById("scrollContainer");
  const footerStatus       = document.getElementById("footerStatus");
  const figureOverlay      = document.getElementById("figureOverlay");
  const figureImg          = document.getElementById("figureImg");
  const searchBar          = document.getElementById("searchBar");
  const searchInput        = document.getElementById("searchInput");
  const searchCloseBtn     = document.getElementById("searchCloseBtn");
  const searchPrevBtn      = document.getElementById("searchPrevBtn");
  const searchNextBtn      = document.getElementById("searchNextBtn");
  const searchCount        = document.getElementById("searchCount");
  const bookSearchOverlay  = document.getElementById("bookSearchOverlay");
  const bookSearchList     = document.getElementById("bookSearchList");
  const bookSearchHeader   = document.getElementById("bookSearchHeader");
  const bookSearchCloseBtn = document.getElementById("bookSearchCloseBtn");

  const miSection          = document.getElementById("mi-section");
  const miBtn2d            = document.getElementById("mi-btn-2d");
  const miBtn3d            = document.getElementById("mi-btn-3d");
  const miBtnPanel         = document.getElementById("mi-btn-panel");
  const miBtnText          = document.getElementById("mi-btn-text");
  const sammal2dContainer  = document.getElementById("sammal2d-container");
  const taivaskarttaEl     = document.getElementById("taivaskartta-section");

  const tocOverlay         = document.getElementById("tocOverlay");
  const tocList            = document.getElementById("tocList");
  const tocTextPreview     = document.getElementById("tocTextPreview");
  const tocCloseBtn        = document.getElementById("tocCloseBtn");

  let chapters = [];
  let currentIndex = 0;
  let rawBodyHtmlByIndex = [];
  let currentSearchTerm  = "";
  let currentSearchIndex = -1;

  let mapMode = false;       // false = tekstitila, true = karttatila
  let currentMiView = "2d";

  let sammalInited = false;
  let taivasInited = false;

  // ---------- Utils ----------
  function escapeHtml(str){
    return String(str)
      .replace(/&/g,"&amp;")
      .replace(/</g,"&lt;")
      .replace(/>/g,"&gt;");
  }

  function showStatus(text){
    if(!footerStatus) return;
    footerStatus.textContent = text;
    footerStatus.classList.add("visible");
    if(showStatus._timer) clearTimeout(showStatus._timer);
    showStatus._timer = setTimeout(()=>{
      footerStatus.classList.remove("visible");
    },2200);
  }

  // ---------- Markdown -> HTML ----------
  function mdToHtml(md){
    if(!md) return "";
    let txt = String(md).replace(/\r\n/g,"\n");
    txt = txt.replace(/^## (.*)$/gm, (_, title) => `<h2>${title}</h2>`);
    txt = txt.replace(/\*\*(.+?)\*\*/g, (_, inner) => `<strong>${inner}</strong>`);
    const blocks = txt.split(/\n{2,}/);
    const htmlBlocks = blocks.map(block=>{
      const b = block.trim();
      if(!b) return "";
      if(/^<h[1-3]>/.test(b)) return b;
      return `<p>${b}</p>`;
    });
    return htmlBlocks.join("\n");
  }

  // ---------- MI-synkka ----------
  function syncMIToCurrent(){
    if(!chapters.length) return;
    const ch = chapters[currentIndex];
    if(!ch) return;
    const essayId = ch.id || String(currentIndex+1).padStart(3,"0");

    if(typeof window.setActiveEssayFromHost === "function"){
      try{ window.setActiveEssayFromHost(essayId); }catch(e){}
    }
    if(typeof window.setTaivaskarttaEssay === "function"){
      try{ window.setTaivaskarttaEssay(essayId); }catch(e){}
    }
    updateTocActive();
  }

  // ---------- Luvut (iso tekstitila) ----------
  async function loadChapters(){
    try{
      const res = await fetch("chapters.json");
      if(!res.ok) throw new Error("chapters.json HTTP " + res.status);
      const data = await res.json();
      if(!Array.isArray(data)) throw new Error("chapters.json ei ole taulukko");
      if(!data.length) throw new Error("chapters.json on tyhj√§");
      chapters = data;
      renderAllChapters();
      renderMiniChapters();
      buildToc();
      updateCurrentChapterFromScroll(true);
    }catch(err){
      console.error(err);
      chapterContainer.innerHTML =
        `<p style="color:#b00020;font-size:14px;">Kirjan lataus ep√§onnistui: ${escapeHtml(err.message || String(err))}</p>`;
    }
  }

  function renderAllChapters(){
    if(!chapters.length) return;
    rawBodyHtmlByIndex = [];
    const parts = chapters.map((ch,idx)=>{
      const id   = ch.id || String(idx+1).padStart(3,"0");
      const part = ch.part != null ? ch.part : "";
      const title = ch.title || `Luku ${id}`;
      const bodyHtml = mdToHtml(ch.body_md || "");
      rawBodyHtmlByIndex[idx] = bodyHtml;
      return `
        <article class="chapter-block" data-index="${idx}" data-id="${escapeHtml(id)}">
          <div class="chapter-meta">${part ? `OSA ${escapeHtml(part)} ¬∑ ` : ""}LUKU ${escapeHtml(id)}</div>
          <h1 class="chapter-title">${escapeHtml(title)}</h1>
          <div class="chapter-body" id="chapterBody-${escapeHtml(id)}">${bodyHtml}</div>
        </article>
      `;
    });
    chapterContainer.innerHTML = parts.join("\n");
    scrollContainer.scrollTo({top:0,behavior:"auto"});
  }

  // ---------- Mini-stream oikeaan tekstiruutuun ----------
  function renderMiniChapters(){
    if(!tocTextPreview || !chapters.length) return;
    const parts = chapters.map((ch,idx)=>{
      const id   = ch.id || String(idx+1).padStart(3,"0");
      const part = ch.part != null ? ch.part : "";
      const title = ch.title || `Luku ${id}`;
      const bodyHtml = mdToHtml(ch.body_md || "");
      return `
        <article class="mini-chapter-block" data-index="${idx}" data-id="${escapeHtml(id)}">
          <div class="toc-preview-meta">LUKU ${escapeHtml(id)}${part ? ` ¬∑ OSA ${escapeHtml(part)}` : ""}</div>
          <div class="toc-preview-title">${escapeHtml(title)}</div>
          <div class="toc-preview-body">${bodyHtml}</div>
        </article>
      `;
    });
    tocTextPreview.innerHTML = parts.join("\n");
    tocTextPreview.scrollTop = 0;
  }

  // ---------- Iso tekstin√§kym√§: currentIndex scrollin mukaan ----------
  function updateCurrentChapterFromScroll(initial){
    const blocks = chapterContainer.querySelectorAll(".chapter-block");
    if(!blocks.length) return;
    const containerRect = scrollContainer.getBoundingClientRect();
    let bestIdx = 0;
    let bestDist = Infinity;
    blocks.forEach(block=>{
      const rect = block.getBoundingClientRect();
      const dy = rect.top - containerRect.top;
      const dist = Math.abs(dy);
      if(dist < bestDist){
        bestDist = dist;
        const idx = Number(block.dataset.index || 0);
        bestIdx = isNaN(idx) ? 0 : idx;
      }
    });
    if(bestIdx !== currentIndex || initial){
      currentIndex = bestIdx;
      const ch = chapters[currentIndex];
      const id = ch.id || String(currentIndex+1).padStart(3,"0");
      const title = ch.title || `Luku ${id}`;
      showStatus(`Luku ${id} ‚Äì ${title}`);
      syncMIToCurrent();
    }
  }

  // ---------- Mini-tekstiruutu: currentIndex scrollin mukaan ----------
  function updateCurrentChapterFromMiniScroll(initial){
    if(!tocTextPreview) return;
    const blocks = tocTextPreview.querySelectorAll(".mini-chapter-block");
    if(!blocks.length) return;
    const containerRect = tocTextPreview.getBoundingClientRect();
    let bestIdx = 0;
    let bestDist = Infinity;
    blocks.forEach(block=>{
      const rect = block.getBoundingClientRect();
      const dy = rect.top - containerRect.top;
      const dist = Math.abs(dy);
      if(dist < bestDist){
        bestDist = dist;
        const idx = Number(block.dataset.index || 0);
        bestIdx = isNaN(idx) ? 0 : idx;
      }
    });
    if(bestIdx !== currentIndex || initial){
      currentIndex = bestIdx;
      const ch = chapters[currentIndex];
      const id = ch.id || String(currentIndex+1).padStart(3,"0");
      const title = ch.title || `Luku ${id}`;
      showStatus(`Luku ${id} ‚Äì ${title}`);
      syncMIToCurrent();
    }
  }

  function scrollToChapter(idx){
    if(!chapters.length) return;
    idx = Math.max(0, Math.min(chapters.length-1, idx));
    const block = chapterContainer.querySelector(`.chapter-block[data-index="${idx}"]`);
    if(!block) return;
    currentIndex = idx;
    const top = block.offsetTop;
    scrollContainer.scrollTo({top, behavior:"smooth"});
    const ch = chapters[currentIndex];
    const id = ch.id || String(currentIndex+1).padStart(3,"0");
    const title = ch.title || `Luku ${id}`;
    showStatus(`Luku ${id} ‚Äì ${title}`);
    syncMIToCurrent();
  }

  function scrollMiniToChapter(idx){
    if(!tocTextPreview || !chapters.length) return;
    idx = Math.max(0, Math.min(chapters.length-1, idx));
    const block = tocTextPreview.querySelector(`.mini-chapter-block[data-index="${idx}"]`);
    if(!block) return;
    currentIndex = idx;
    const top = block.offsetTop;
    tocTextPreview.scrollTo({ top, behavior: "smooth" });
    const ch = chapters[currentIndex];
    const id = ch.id || String(currentIndex+1).padStart(3,"0");
    const title = ch.title || `Luku ${id}`;
    showStatus(`Luku ${id} ‚Äì ${title}`);
    syncMIToCurrent();
  }

  // ---------- TOC + active-highlight ----------
  function buildToc(){
    tocList.innerHTML = "";
    chapters.forEach((ch,idx)=>{
      const li = document.createElement("li");
      const id = ch.id || String(idx+1).padStart(3,"0");
      const part = ch.part != null ? ch.part : "";
      li.dataset.index = idx;
      li.innerHTML = `
        <div class="toc-meta">${part ? `OSA ${escapeHtml(part)} ¬∑ ` : ""}LUKU ${escapeHtml(id)}</div>
        <div class="toc-title">${escapeHtml(ch.title || `Luku ${id}`)}</div>
      `;
      li.addEventListener("click",()=>{
        if(mapMode){
          scrollMiniToChapter(idx);
        }else{
          scrollToChapter(idx);
        }
      });
      tocList.appendChild(li);
    });
    updateTocActive();
  }

  function updateTocActive(){
    if(!tocList || !chapters.length) return;
    const items = tocList.querySelectorAll("li");
    items.forEach(li=>{
      const idx = Number(li.dataset.index || 0);
      if(idx === currentIndex) li.classList.add("toc-current");
      else li.classList.remove("toc-current");
    });
  }

  tocCloseBtn.addEventListener("click", ()=>{ showTextOnly(); });

  // ---------- MI-alue (2D/3D) ----------
  function setMiView(mode){
    currentMiView = mode;
    if(mode === "2d"){
      sammal2dContainer.style.display = "block";
      taivaskarttaEl.style.display    = "none";
      miBtn2d.classList.add("mi-active");
      miBtn3d.classList.remove("mi-active");
      if(mapMode) showStatus("Sammalkartta 2D");
    }else{
      sammal2dContainer.style.display = "none";
      taivaskarttaEl.style.display    = "block";
      miBtn3d.classList.add("mi-active");
      miBtn2d.classList.remove("mi-active");
      if(mapMode) showStatus("Taivaskartta 3D");
    }
  }

  function initSammalIfNeeded(){
    if(sammalInited) return;
    if(typeof window.mountSammalkarttaInline === "function"){
      try{
        window.mountSammalkarttaInline(sammal2dContainer,{ viewMode:"2d" });
        sammalInited = true;
      }catch(e){ console.warn("mountSammalkarttaInline-virhe:", e); }
    }
  }

  function initTaivasIfNeeded(){
    if(taivasInited) return;
    if(typeof window.initTaivaskartta === "function"){
      try{
        window.initTaivaskartta("taivaskartta-section");
        taivasInited = true;
      }catch(e){ console.warn("initTaivaskartta-virhe:", e); }
    }
  }

  function initMIViews(){
    setMiView("2d");   // oletus
  }

  function showMapAndToc(){
    miSection.style.display   = "block";
    tocOverlay.style.display  = "flex";
    scrollContainer.style.display = "none";
    mapMode = true;

    initSammalIfNeeded();
    initTaivasIfNeeded();
    setMiView(currentMiView);
    updateCurrentChapterFromMiniScroll(true);
  }

  function showTextOnly(){
    miSection.style.display   = "none";
    tocOverlay.style.display  = "none";
    scrollContainer.style.display = "block";
    mapMode = false;
  }

  function toggleTextAndToc(){
    if(mapMode) showTextOnly();
    else showMapAndToc();
  }

  if(miBtn2d){
    miBtn2d.addEventListener("click", ()=>{ setMiView("2d"); showMapAndToc(); });
  }
  if(miBtn3d){
    miBtn3d.addEventListener("click", ()=>{ setMiView("3d"); showMapAndToc(); });
  }

  // Teksti-painike: vaihtaa teksti <-> kartta+hakemisto
  if(miBtnText){
    miBtnText.addEventListener("click", ()=>{ toggleTextAndToc(); });
  }

  // Paneli-painike: kelluva MI-paneli (taivaskartta.js)
if(miBtnPanel){
  miBtnPanel.addEventListener("click", ()=>{
    if (typeof window.toggleTaivaskarttaPanel === "function"){
      window.toggleTaivaskarttaPanel();
    }
  });
}

  // ---------- Textipaneelin swipe (vain vasen/oikea) ----------
  (function(){
    if(!tocTextPreview) return;
    let startX=0,startY=0;

    tocTextPreview.addEventListener("touchstart",e=>{
      if(e.touches.length!==1) return;
      const t = e.touches[0];
      startX = t.clientX;
      startY = t.clientY;
    },{passive:true});

    tocTextPreview.addEventListener("touchend",e=>{
      if(e.changedTouches.length!==1) return;
      const t = e.changedTouches[0];
      const dx = t.clientX - startX;
      const dy = t.clientY - startY;
      const absDx = Math.abs(dx), absDy = Math.abs(dy);

      if(absDx > 60 && absDx > absDy){
        if(dx < 0 && currentIndex < chapters.length-1){
          scrollMiniToChapter(currentIndex+1);
        }else if(dx > 0 && currentIndex > 0){
          scrollMiniToChapter(currentIndex-1);
        }
      }
    },{passive:true});
  })();

  // ---------- Infografiikka ----------
  function openFigureForCurrent(){
    if(!chapters.length) return;
    const ch = chapters[currentIndex];
    const id = ch.id || String(currentIndex+1).padStart(3,"0");
    const png = `images/${id}.png`;
    const jpg = `images/${id}.jpg`;
    const img = new Image();
    img.onload = ()=>{
      figureImg.src = img.src;
      figureOverlay.style.display = "flex";
    };
    img.onerror = ()=>{
      if(img.src.endsWith(".png")) img.src = jpg;
      else showStatus(`Infografiikkaa ei l√∂ytynyt luvulle ${id}`);
    };
    img.src = png;
  }
  figureOverlay.addEventListener("click",()=>{ figureOverlay.style.display = "none"; });

  // ---------- Koko kirjan haku ----------
  function searchWholeBook(term){
    if(!chapters.length || !term) return;
    const t = term.toLowerCase();
    const results = [];
    chapters.forEach((ch, idx)=>{
      const text = (ch.body_md || "").toLowerCase();
      let count = 0;
      if(term.length >= 4){
        const m = text.match(new RegExp(t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"), "g"));
        count = m ? m.length : 0;
      }else{
        const re = new RegExp("\\b" + t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&") + "\\b","gi");
        const m = text.match(re);
        count = m ? m.length : 0;
      }
      if(count > 0){
        results.push({ idx, id: ch.id || String(idx+1).padStart(3,"0"), title: ch.title || "", count });
      }
    });
    showWholeBookResults(term, results);
  }

  function showWholeBookResults(term, results){
    if(!bookSearchOverlay || !bookSearchList || !bookSearchHeader) return;
    bookSearchOverlay.style.display = "flex";
    bookSearchHeader.querySelector("span").textContent = `Hakutulokset: "${term}"`;
    bookSearchList.innerHTML = "";
    if(!results.length){
      bookSearchList.innerHTML = "<li>Ei osumia.</li>";
      return;
    }
    results.forEach(r=>{
      const li = document.createElement("li");
      li.textContent = `LUKU ${r.id} ‚Äì ${r.count} osumaa`;
      li.addEventListener("click", ()=>{
        bookSearchOverlay.style.display = "none";
        scrollToChapter(r.idx);
        openSearchBar();
        searchInput.value = term;
        runSearchInChapter(term);
      });
      bookSearchList.appendChild(li);
    });
  }

  if(bookSearchCloseBtn){
    bookSearchCloseBtn.addEventListener("click", ()=>{ bookSearchOverlay.style.display = "none"; });
  }

  // ---------- Luvun sis√§inen haku ----------
  function restoreChapterBody(idx){
    const ch = chapters[idx];
    if(!ch) return;
    const id = ch.id || String(idx+1).padStart(3,"0");
    const bodyEl = document.getElementById(`chapterBody-${id}`);
    if(!bodyEl) return;
    bodyEl.innerHTML = rawBodyHtmlByIndex[idx] || "";
  }

  function getCurrentMarks(){
    const ch = chapters[currentIndex];
    if(!ch) return [];
    const id = ch.id || String(currentIndex+1).padStart(3,"0");
    const bodyEl = document.getElementById(`chapterBody-${id}`);
    if(!bodyEl) return [];
    return Array.from(bodyEl.querySelectorAll("mark"));
  }

  function updateSearchCount(total, idx){
    if(!searchCount) return;
    if(!total || idx < 0) searchCount.textContent = "0/0";
    else searchCount.textContent = (idx+1) + "/" + total;
  }

  function scrollToMarkAt(idx){
    const marks = getCurrentMarks();
    if(!marks.length){
      currentSearchIndex = -1;
      updateSearchCount(0,-1);
      return;
    }
    if(idx < 0) idx = marks.length - 1;
    if(idx >= marks.length) idx = 0;
    currentSearchIndex = idx;
    const mark = marks[idx];
    const containerTop = scrollContainer.getBoundingClientRect().top;
    const markTop = mark.getBoundingClientRect().top;
    const delta = markTop - containerTop - 40;
    scrollContainer.scrollBy({ top: delta, behavior:"smooth" });
    updateSearchCount(marks.length, currentSearchIndex);
  }

  function buildSearchRegex(term){
    const safeTerm = term.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");
    if(term.length >= 4) return new RegExp(safeTerm,"gi");
    return new RegExp("\\b" + safeTerm + "\\b","gi");
  }

  function runSearchInChapter(term){
    if(!chapters.length) return;
    const ch = chapters[currentIndex];
    if(!ch) return;
    const id = ch.id || String(currentIndex+1).padStart(3,"0");
    const bodyEl = document.getElementById(`chapterBody-${id}`);
    if(!bodyEl) return;

    currentSearchTerm = term;
    if(!term){
      restoreChapterBody(currentIndex);
      currentSearchIndex = -1;
      updateSearchCount(0,-1);
      showStatus("Haku tyhjennetty.");
      return;
    }

    restoreChapterBody(currentIndex);
    const original = rawBodyHtmlByIndex[currentIndex] || bodyEl.innerHTML;
    const re = buildSearchRegex(term);
    const highlighted = original.replace(re, m => `<mark>${escapeHtml(m)}</mark>`);
    bodyEl.innerHTML = highlighted;
    const marks = getCurrentMarks();
    if(marks.length){
      currentSearchIndex = 0;
      scrollToMarkAt(0);
      showStatus(`Korostettu: "${term}"`);
    }else{
      currentSearchIndex = -1;
      updateSearchCount(0,-1);
      showStatus(`Ei osumia: "${term}"`);
    }
  }

  function openSearchBar(){
    if(!chapters.length || !searchBar) return;
    searchBar.style.display = "flex";
    searchInput.value = currentSearchTerm || "";
    searchInput.focus();
    restoreChapterBody(currentIndex);
    currentSearchIndex = -1;
    updateSearchCount(0,-1);
  }
  function closeSearchBar(){ if(searchBar) searchBar.style.display = "none"; }

  if(searchInput){
    searchInput.addEventListener("keydown", e=>{
      if(e.key === "Enter"){
        const term = searchInput.value.trim();
        if(term) searchWholeBook(term);
      }
    });
  }
  if(searchCloseBtn) searchCloseBtn.addEventListener("click", ()=>{ closeSearchBar(); });
  if(searchNextBtn){
    searchNextBtn.addEventListener("click", ()=>{
      const marks = getCurrentMarks();
      if(!marks.length) return;
      const nextIdx = (currentSearchIndex < 0 ? 0 : currentSearchIndex + 1);
      scrollToMarkAt(nextIdx);
    });
  }
  if(searchPrevBtn){
    searchPrevBtn.addEventListener("click", ()=>{
      const marks = getCurrentMarks();
      if(!marks.length) return;
      const prevIdx = (currentSearchIndex < 0 ? marks.length - 1 : currentSearchIndex - 1);
      scrollToMarkAt(prevIdx);
    });
  }

  // ---------- Kaksoisn√§p√§ytys isossa tekstiss√§ -> karttatila ----------
  (function(){
    let lastTapTime = 0, lastTapX = 0, lastTapY = 0;
    const DOUBLE_TAP_DELAY = 350;
    const MAX_MOVE = 20;
    scrollContainer.addEventListener("pointerup", e => {
      if(figureOverlay.style.display === "flex") return;
      if(e.button !== 0) return;
      const x = e.clientX, y = e.clientY;
      const now = Date.now();
      const dt = now - lastTapTime;
      const dx = x - lastTapX, dy = y - lastTapY;
      if(dt < DOUBLE_TAP_DELAY && Math.hypot(dx,dy) < MAX_MOVE){
        showMapAndToc();
        lastTapTime = 0;
      }else{
        lastTapTime = now; lastTapX = x; lastTapY = y;
      }
    }, {passive:true});
  })();

  // ---------- Swipe vasen/oikea isossa tekstiss√§ ----------
  let touchStartX = 0, touchStartY = 0;
  scrollContainer.addEventListener("touchstart",e=>{
    if(e.touches.length!==1) return;
    const t = e.touches[0];
    touchStartX = t.clientX;
    touchStartY = t.clientY;
  },{passive:true});
  scrollContainer.addEventListener("touchend",e=>{
    if(e.changedTouches.length!==1) return;
    const t = e.changedTouches[0];
    const dx = t.clientX - touchStartX;
    const dy = t.clientY - touchStartY;
    const absDx = Math.abs(dx), absDy = Math.abs(dy);
    if(absDx>60 && absDx>absDy){
      if(dx<0 && currentIndex<chapters.length-1) scrollToChapter(currentIndex+1);
      else if(dx>0 && currentIndex>0) scrollToChapter(currentIndex-1);
    }
  },{passive:true});

  // ---------- Scroll -> currentIndex isossa n√§kym√§ss√§ ----------
  scrollContainer.addEventListener("scroll",()=>{
    if(!chapters.length) return;
    if(!mapMode) updateCurrentChapterFromScroll(false);
  },{passive:true});

  // ---------- Mini-tekstiruudun scroll -> currentIndex ----------
  if(tocTextPreview){
    tocTextPreview.addEventListener("scroll",()=>{
      if(!chapters.length) return;
      if(mapMode) updateCurrentChapterFromMiniScroll(false);
    },{passive:true});
  }

  // ---------- Init ----------
  loadChapters();
  initMIViews();
  showTextOnly();
})();
</script>

</body>
</html>
