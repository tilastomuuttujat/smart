<!DOCTYPE html>
<html lang="fi">
<head>
<meta charset="UTF-8" />
<title>Genesis Ultimate Editor δ - Minimal Schema</title>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const app = initializeApp({
  apiKey: "AIzaSyBTC0eygSgWe7tFz11kopqqWAmBmKNTJl0",
  authDomain: "interaktiivinen-esseekok-3bf69.firebaseapp.com",
  projectId: "interaktiivinen-esseekok-3bf69"
});
const db = getFirestore(app);

let items = [];
let current = null;

function normalizeToFlat(raw, isJsonUpdate = false) {
  const src = raw || {};
  const cur = current || {};

  return {
    id: src.id ?? (isJsonUpdate ? cur.id : ""),
    part: src.part ?? (isJsonUpdate ? cur.part : ""), // Säilyy merkkijonona
    title: src.title ?? (isJsonUpdate ? cur.title : ""),
    subtitle: src.subtitle ?? (isJsonUpdate ? cur.subtitle : ""),
    content: src.content ?? (isJsonUpdate ? cur.content : (src.body_md || ""))
  };
}

async function load() {
  onSnapshot(collection(db, "kirja"), (snap) => {
    items = snap.docs.map(d => d.data());
    renderList();
    if (!current && items.length > 0) openItem(0);
  });
}
window.addEventListener("DOMContentLoaded", load);

function renderList() {
  const list = document.getElementById("list");
  list.innerHTML = items.map((e, i) => 
    `<div class="item ${current?.id === e.id ? 'active' : ''}" onclick="openItem(${i})">${e.title || e.id || 'Nimetön'}</div>`
  ).join("");
}

window.openItem = i => {
  current = normalizeToFlat(items[i]);
  bindToUI();
  renderList();
};

function bindToUI() {
  document.querySelectorAll("[data-path]").forEach(el => {
    const path = el.dataset.path;
    const val = current[path];
    el.value = val ?? "";
  });
  updateJsonPreview();
  updateWordCount(); 
}

window.updateDataFromUI = () => {
  document.querySelectorAll("[data-path]").forEach(el => {
    const path = el.dataset.path;
    let val = el.value;
    // POISTETTU: Number(val) -muunnos, jotta part pysyy merkkijonona
    current[path] = val;
  });
  updateJsonPreview();
};

window.copyOutput = (el) => {
  el.select();
  document.execCommand("copy");
  document.getElementById("status-msg").innerText = "Kopioitu!";
  setTimeout(() => document.getElementById("status-msg").innerText = "Valmis", 2000);
};

window.handleJsonUpdate = () => {
  const inputEl = document.getElementById("jsonInput");
  try {
    const newData = JSON.parse(inputEl.value);
    current = normalizeToFlat(newData, true);
    bindToUI();
    document.getElementById("status-msg").innerText = "JSON päivitetty!";
  } catch (e) { }
};

function updateJsonPreview() {
  document.getElementById("jsonPreview").value = JSON.stringify(current, null, 2);
}

window.save = async () => {
  if (!current?.id) return alert("ID puuttuu!");
  window.updateDataFromUI();
  const cleanData = normalizeToFlat(current);
  await setDoc(doc(db, "kirja", cleanData.id), cleanData, { merge: false });
  document.getElementById("status-msg").innerText = "TALLENNETTU!";
  setTimeout(() => document.getElementById("status-msg").innerText = "Valmis", 2000);
};

window.updateWordCount = function () {
  const ta = document.getElementById("bodyEditor");
  const out = document.getElementById("wordCount");
  if (!ta || !out) return;
  const words = ta.value.trim() ? ta.value.trim().split(/\s+/).length : 0;
  out.textContent = `Sanamäärä: ${words}`;
};

</script>

<style>
  :root { --bg: #0f172a; --accent: #38bdf8; --text: #f8fafc; }
  body { font-family: 'Inter', sans-serif; margin: 0; display: flex; height: 100vh; background: #f1f5f9; }
  #sidebar { width: 220px; background: var(--bg); color: white; overflow-y: auto; border-right: 1px solid #1e293b; }
  .item { padding: 12px 20px; cursor: pointer; border-bottom: 1px solid #1e293b; font-size: 13px; color: #94a3b8; }
  .item.active { background: var(--accent); color: var(--bg); font-weight: bold; }
  #main { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
  .toolbar { padding: 15px 25px; background: white; border-bottom: 1px solid #e2e8f0; display: flex; gap: 10px; align-items: center; }
  .editor-area { flex: 1; padding: 25px; overflow-y: auto; }
  label { display: block; font-size: 10px; font-weight: 800; color: #64748b; text-transform: uppercase; margin: 10px 0 4px; }
  input, textarea { width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; box-sizing: border-box; font-size: 14px; }
  textarea { height: 400px; font-family: 'Charter', serif; line-height: 1.6; }
  .json-preview { background: var(--bg); color: var(--accent); font-family: monospace; height: 140px; margin-top: 20px; font-size: 11px; }
  .btn-save { background: #10b981; color: white; border: none; padding: 10px 20px; border-radius: 6px; font-weight: bold; cursor: pointer; margin-left: auto; }
</style>
</head>

<body>
<div id="sidebar"><div id="list"></div></div>

<div id="main">
  <div class="toolbar">
    <span id="status-msg" style="font-size: 12px; font-weight: bold; color: #10b981;">Valmis</span>
    <button class="btn-save" onclick="save()">TALLENNA KIRJAAN</button>
  </div>

  <div class="editor-area">
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
      <div><label>ID</label><input data-path="id" oninput="updateDataFromUI()"></div>
      <div><label>Part (String)</label><input type="text" data-path="part" oninput="updateDataFromUI()"></div>
    </div>
    
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-top: 10px;">
      <div><label>Title</label><input data-path="title" oninput="updateDataFromUI()"></div>
      <div><label>Subtitle</label><input data-path="subtitle" oninput="updateDataFromUI()"></div>
    </div>

    <label style="margin-top: 20px;">Content</label> 
    <textarea id="bodyEditor" data-path="content" oninput="updateDataFromUI(); updateWordCount();"></textarea>
    <div id="wordCount" style="margin-top:6px; font-size:12px; color:#64748b;">Sanamäärä: 0</div>

    <hr style="margin: 30px 0; border: 0; border-top: 1px solid #e2e8f0;">
    
    <label>JSON Esikatselu</label>
    <textarea id="jsonPreview" class="json-preview" readonly onclick="copyOutput(this)"></textarea>
    
    <label>Päivitä data liittämällä JSON</label>
    <input id="jsonInput" placeholder="Liitä JSON tähän..." oninput="handleJsonUpdate()">
  </div>
</div>

</body>
</html>